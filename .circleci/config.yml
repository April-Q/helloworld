version: 2
jobs:
  build:
    machine: true
    environment:
      KIND_VERSION: "v0.7.0"
      KUBECTL_VERSION: "v1.17.0"
    steps:
    - checkout
    - run:
        name: install kind
        command: |
          curl -LO https://github.com/kubernetes-sigs/kind/releases/download/$KIND_VERSION/kind-Linux-amd64
          chmod +x kind-Linux-amd64
          sudo mv kind-Linux-amd64 /usr/local/bin/kind
    - run:
        name: create cluster
        command: |
          if kind create cluster; then
            echo "Cluster created"
          else
            echo "Cluster creation failed, retrying"
            kind delete cluster || true
            kind create cluster
          fi
    - run:
        name: install kubectl
        command: |
          curl -LO https://storage.googleapis.com/kubernetes-release/release/$KUBECTL_VERSION/bin/linux/amd64/kubectl
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl
          echo "export KUBECONFIG=$(kind get kubeconfig)" >> $BASH_ENV
        